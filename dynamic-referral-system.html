<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Referral Link Handler</title>
    <script>
        // Configuration object - Replace with your app's details
        const config = {
            androidPackage: 'com.yourapp.package',
            iOSBundleId: 'com.yourapp.bundle',
            androidPlayStoreUrl: 'https://play.google.com/store/apps/details?id=com.yourapp.package',
            iOSAppStoreUrl: 'https://apps.apple.com/app/yourapp/id123456789',
            appScheme: 'yourapp://',
            fallbackUrl: 'https://yourwebsite.com'
        };

        // Function to generate a referral code
        function generateReferralCode(length = 8) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Function to get URL parameters
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return Object.fromEntries(params.entries());
        }

        // Function to detect device type
        function detectDevice() {
            const userAgent = navigator.userAgent.toLowerCase();
            if (/iphone|ipad|ipod/.test(userAgent)) {
                return 'ios';
            } else if (/android/.test(userAgent)) {
                return 'android';
            }
            return 'desktop';
        }

        // Function to check if app is installed
        function checkAppInstalled(callback) {
            const device = detectDevice();
            const appScheme = config.appScheme;
            
            // Hidden iframe technique for detection
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            document.body.appendChild(iframe);

            // Timeout for app launch check
            const timeoutDuration = 2000;
            let timeout;

            // If browser doesn't change focus within timeout, app is not installed
            const handleBlur = () => {
                clearTimeout(timeout);
                window.removeEventListener('blur', handleBlur);
                callback(true);
            };

            window.addEventListener('blur', handleBlur);

            timeout = setTimeout(() => {
                window.removeEventListener('blur', handleBlur);
                iframe.remove();
                callback(false);
            }, timeoutDuration);

            // Try to open app
            if (device === 'ios') {
                iframe.src = appScheme;
            } else if (device === 'android') {
                iframe.src = `intent://${appScheme.replace('://', '')}#Intent;package=${config.androidPackage};scheme=https;end`;
            }
        }

        // Function to handle deep linking
        function handleDeepLink() {
            const params = getUrlParams();
            const referralCode = params.ref || generateReferralCode();
            const device = detectDevice();

            checkAppInstalled((isInstalled) => {
                if (isInstalled) {
                    // Deep link to app with referral code
                    const deepLink = `${config.appScheme}referral?code=${referralCode}`;
                    window.location.href = deepLink;
                } else {
                    // Redirect to appropriate store
                    if (device === 'ios') {
                        window.location.href = config.iOSAppStoreUrl;
                    } else if (device === 'android') {
                        window.location.href = config.androidPlayStoreUrl;
                    } else {
                        window.location.href = config.fallbackUrl;
                    }
                }
            });
        }

        // Function to generate a shareable link
        function generateShareableLink(referralCode = null) {
            const code = referralCode || generateReferralCode();
            const baseUrl = window.location.origin + window.location.pathname;
            return `${baseUrl}?ref=${code}`;
        }

        // Initialize when page loads
        window.onload = function() {
            handleDeepLink();
        };
    </script>
</head>
<body>
    <div id="loading" style="text-align: center; padding: 20px;">
        Redirecting to app...
    </div>
</body>
</html>
